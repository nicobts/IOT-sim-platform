name: Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - staging
          - production
      version:
        description: 'Version to deploy (tag or branch)'
        required: true
        default: 'main'

jobs:
  deploy:
    name: Deploy to ${{ inputs.environment }}
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    steps:
    - uses: actions/checkout@v3
      with:
        ref: ${{ inputs.version }}

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Configure SSH
      if: inputs.environment == 'production'
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts

    - name: Deploy to staging
      if: inputs.environment == 'staging'
      run: |
        echo "Deploying to staging environment..."
        echo "Version: ${{ inputs.version }}"
        # Add staging deployment commands here
        # Example: docker-compose -f docker-compose.staging.yml up -d

    - name: Deploy to production
      if: inputs.environment == 'production'
      run: |
        echo "Deploying to production environment..."
        echo "Version: ${{ inputs.version }}"

        # Copy files to server
        scp -r docker-compose.prod.yml ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:~/iot-platform/
        scp -r monitoring/ ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:~/iot-platform/
        scp -r nginx/ ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:~/iot-platform/

        # Deploy on server
        ssh ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} << 'EOF'
          cd ~/iot-platform

          # Pull latest images
          docker-compose -f docker-compose.prod.yml pull

          # Run database migrations
          docker-compose -f docker-compose.prod.yml run --rm backend alembic upgrade head

          # Deploy with zero-downtime
          docker-compose -f docker-compose.prod.yml up -d --no-deps --build

          # Health check
          sleep 10
          curl -f http://localhost:8000/health || exit 1

          echo "Deployment successful!"
        EOF

    - name: Notify deployment status
      if: always()
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        text: |
          Deployment to ${{ inputs.environment }} ${{ job.status }}
          Version: ${{ inputs.version }}
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}

  rollback:
    name: Rollback
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()

    steps:
    - name: Rollback deployment
      run: |
        echo "Deployment failed. Initiating rollback..."
        # Add rollback commands here
        # Example: Redeploy previous version

    - name: Notify rollback
      uses: 8398a7/action-slack@v3
      with:
        status: custom
        custom_payload: |
          {
            text: "ðŸ”„ Rollback initiated for ${{ inputs.environment }}",
            attachments: [{
              color: 'warning',
              text: 'Deployment failed, rolling back to previous version'
            }]
          }
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
